version: 2
jobs:
  build:
    docker:
      - image: circleci/php:7.1-cli
    enviroment:
      filepath_upload: ~/code/.circleci/sample/zoho-logo-zh-2x.png
      applicationLogFilePath: ~/code/client/logs
      token_persistence_path: ~/code/client/token
      persistence_handler_class: ZohoOAuthPersistenceByFile
    working_directory: ~/code
    steps:
      - checkout
      # Init Zoho environment for API
      - run: mkdir -p ~/code/client/logs
      - run: touch ~/code/client/logs/ZCRMClientLibrary.log
      - run: mkdir -p ~/code/client/token
      - run: touch client/token/zcrm_oauthtokens.txt
      - run: sudo composer self-update
      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "composer.json" }}
            - v1-dependencies-
      - run: composer install -n --prefer-dist
      - save_cache:
          key: v1-dependencies-{{ checksum "composer.json" }}
          paths:
            - ./vendor
      - run: chmod -R 755 ~/code/client
      - run: vendor/bin/phpunit

workflows:
  Setup:
    jobs:
      - build
  version: 2