version: 2
jobs:
  build:
    docker:
      - image: circleci/php:7.1-cli
    steps:
      - checkout
      - run: sudo composer self-update
      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "composer.json" }}
            - v1-dependencies-
      - run: composer install -n --prefer-dist
      - save_cache:
          key: v1-dependencies-{{ checksum "composer.json" }}
          paths:
            - ./vendor
      # Init Zoho environment for API
      - run: mkdir -p client/logs
      - run: touch client/logs/ZCRMClientLibrary.log
      - run: mkdir -p client/token
      - run: touch client/token/zcrm_oauthtokens.txt
      - run:
          name: Run Zoho Token
          command: php /home/circleci/project/.circleci/scripts/zohoTokenDeploy.php
          environment:
            APPLICATION_LOG_FILE_PATH: /home/circleci/project/client/logs
            TOKEN_PERSISTENCE_PATH: /home/circleci/project/client/token
            PERSISTENCE_HANDLER_CLASS: ZohoOAuthPersistenceByFile
      - run:
          name: Run Unit Tests
          command: vendor/bin/phpunit
          environment:
            FILEPATH_TEST_UPLOAD: /home/circleci/project/.circleci/sample/zoho-logo-zh-2x.png
            APPLICATION_LOG_FILE_PATH: /home/circleci/project/client/logs
            TOKEN_PERSISTENCE_PATH: /home/circleci/project/client/token
            PERSISTENCE_HANDLER_CLASS: ZohoOAuthPersistenceByFile

workflows:
  Setup:
    jobs:
      - build
  version: 2